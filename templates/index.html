<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Goldfish Pose Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet">

  <!-- Font Awesome -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<div class="page-root">

  <!-- Top Navigation -->
  <header class="topnav shadow-sm">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
        <div class="brand-badge">
          <i class="fa-solid fa-fish-fins"></i>
        </div>
        <div>
          <div class="brand-main">Goldfish Pose Analyzer</div>
          <div class="brand-sub">
            Analisis panjang dan jumlah ikan berbasis YOLOv8-Pose
          </div>
        </div>
      </div>

      <div class="d-flex align-items-center gap-3 topnav-right">
        <div class="chip chip-soft">
          <i class="fa-regular fa-circle-check me-1"></i>
          Model siap digunakan
        </div>
        <div class="chip chip-ghost d-none d-md-inline-flex">
          <i class="fa-solid fa-microchip me-1"></i>
          Engine: YOLOv8-Pose
        </div>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="main-panel container-fluid">
    <div class="row g-4">

      <!-- Upload column -->
      <section class="col-lg-3 col-md-4">
        <div class="card card-panel h-100">
          <div class="card-body">
            <div class="section-title">
              <span class="section-icon">
                <i class="fa-solid fa-cloud-arrow-up"></i>
              </span>
              <div>
                <div class="section-heading">Unggah Video</div>
                <div class="section-caption">
                  Gunakan rekaman dari kamera atas dengan ikan mas di dalam kolam atau akuarium.
                </div>
              </div>
            </div>

            <form id="uploadForm"
                  action="{{ url_for('upload_and_process') }}"
                  method="post"
                  enctype="multipart/form-data"
                  class="mt-3">
              <div class="mb-3">
                <label class="form-label form-label-sm fw-semibold">
                  Berkas video
                </label>
                <input type="file"
                       class="form-control form-control-sm"
                       name="video"
                       accept="video/*"
                       required>
                <div class="form-text form-text-extra">
                  Disarankan format MP4, durasi 10–60 detik agar proses lebih cepat.
                </div>
              </div>

              <button type="submit" class="btn btn-primary w-100 btn-analyze">
                <i class="fa-solid fa-magnifying-glass-chart me-2"></i>
                Cek Ikan
              </button>
            </form>

            {% with messages = get_flashed_messages() %}
            {% if messages %}
              <div class="alert alert-warning alert-compact mt-3 mb-0">
                {% for m in messages %}
                  <div>{{ m }}</div>
                {% endfor %}
              </div>
            {% endif %}
            {% endwith %}

            {% if runs %}
              <hr class="soft-divider my-4">
              <div class="small fw-semibold text-muted text-uppercase mb-2">
                Riwayat ringkas
              </div>
              <ul class="list-unstyled history-list">
                {% for r in runs[-6:]|reverse %}
                  <li class="history-item">
                    <div class="history-icon">
                      <i class="fa-regular fa-file-lines"></i>
                    </div>
                    <div class="history-text text-truncate" title="{{ r }}">
                      {{ r }}
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- Result / dashboard column -->
      <section class="col-lg-9 col-md-8">
        <div class="card card-panel mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
              <div>
                <div class="section-heading d-flex align-items-center gap-2 mb-1">
                  <span class="section-icon section-icon-primary">
                    <i class="fa-solid fa-chart-column"></i>
                  </span>
                  Ringkasan Analisis
                </div>
                <div class="section-caption">
                  Statistik diperoleh dari deteksi keypoint kepala–ekor dan pelacakan ID ikan pada frame video yang diproses.
                </div>
              </div>

              {% if result %}
              <div class="text-end small text-muted">
                <div>
                  Run ID:
                  <span class="badge bg-light text-body border">
                    {{ result.run_id }}
                  </span>
                </div>
                <div>
                  Video:
                  <span class="text-body">{{ result.input_video_name }}</span>
                </div>
              </div>
              {% endif %}
            </div>

            {% if result %}
              <!-- Metrics row: jumlah, ikan besar, ikan kecil -->
              <div class="row g-3 mb-4">
                <div class="col-lg-4 col-sm-6">
                  <div class="stat-card">
                    <div class="stat-icon stat-icon-primary">
                      <i class="fa-solid fa-fish"></i>
                    </div>
                    <div class="stat-label">Jumlah ikan</div>
                    <div class="stat-value">
                      {{ result.summary.estimated_fish_count or 0 }}
                    </div>
                    <div class="stat-note">
                      Perkiraan jumlah individu berdasarkan ID hasil pelacakan.
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-sm-6">
                  <div class="stat-card">
                    <div class="stat-icon stat-icon-accent">
                      <i class="fa-solid fa-ruler-combined"></i>
                    </div>
                    <div class="stat-label">Ikan terbesar</div>
                    <div class="stat-value">
                      {% if result.summary.fish_big_cm %}
                        {{ "%.1f"|format(result.summary.fish_big_cm) }}
                        <span class="stat-unit">cm</span>
                      {% else %}—{% endif %}
                    </div>
                    <div class="stat-note">
                      Rata-rata panjang ikan kategori besar (≥ 12 cm).
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-sm-6">
                  <div class="stat-card">
                    <div class="stat-icon stat-icon-soft">
                      <i class="fa-regular fa-circle-dot"></i>
                    </div>
                    <div class="stat-label">Ikan terkecil</div>
                    <div class="stat-value">
                      {% if result.summary.fish_small_cm %}
                        {{ "%.1f"|format(result.summary.fish_small_cm) }}
                        <span class="stat-unit">cm</span>
                      {% else %}—{% endif %}
                    </div>
                    <div class="stat-note">
                      Rata-rata panjang ikan kategori kecil (6–<12 cm).
                    </div>
                  </div>
                </div>
              </div>

              <!-- Video + detail -->
              <div class="row g-4 align-items-start">
                <div class="col-lg-6">
                  <h6 class="subsection-heading mb-2">
                    <i class="fa-solid fa-video me-2 text-primary"></i>
                    Video hasil anotasi
                  </h6>
                  <div class="ratio ratio-16x9 video-shell">
                    <video id="resultVideo" class="w-100 h-100" controls>
                      <source src="{{ url_for('get_output_video', filename=result.output_video_name) }}" type="video/mp4">
                      Browser Anda tidak mendukung pemutaran video.
                    </video>
                  </div>
                  <div class="small text-muted mt-2">
                    Berkas output:
                    <span class="fw-semibold">{{ result.output_video_name }}</span>
                  </div>
                </div>

                <div class="col-lg-6">
                  <h6 class="subsection-heading mb-2">
                    <i class="fa-solid fa-table-list me-2 text-primary"></i>
                    Ringkasan detail
                  </h6>

                  <table class="table table-sm table-borderless detail-table mb-3">
                    <tbody>
                    <tr>
                      <th>Nama video input</th>
                      <td>{{ result.input_video_name }}</td>
                    </tr>
                    <tr>
                      <th>Run ID</th>
                      <td>{{ result.run_id }}</td>
                    </tr>
                    <tr>
                      <th>Panjang minimum terdeteksi</th>
                      <td>
                        {% if result.summary.min_length_cm %}
                          {{ "%.2f"|format(result.summary.min_length_cm) }} cm
                        {% else %}—{% endif %}
                      </td>
                    </tr>
                    <tr>
                      <th>Panjang maksimum terdeteksi</th>
                      <td>
                        {% if result.summary.max_length_cm %}
                          {{ "%.2f"|format(result.summary.max_length_cm) }} cm
                        {% else %}—{% endif %}
                      </td>
                    </tr>
                    </tbody>
                  </table>

                  <a class="btn btn-outline-primary btn-sm"
                     href="{{ url_for('get_output_csv', filename=result.output_csv_name) }}">
                    <i class="fa-solid fa-download me-1"></i>
                    Unduh CSV ringkasan
                  </a>

                  <hr class="soft-divider my-3">

                  <h6 class="subsection-heading mb-2">
                    <i class="fa-solid fa-list-ol me-2 text-primary"></i>
                    Rangkuman per ikan (berdasarkan ID)
                  </h6>

                  {% if result.summary.fish_details %}
                    <table class="table table-sm align-middle mb-0">
                      <thead class="small text-muted">
                      <tr>
                        <th class="w-25">ID Ikan</th>
                        <th>Panjang rata-rata</th>
                      </tr>
                      </thead>
                      <tbody class="small">
                      {% for f in result.summary.fish_details %}
                        <tr>
                          <td>{{ f.id }}</td>
                          <td>{{ "%.2f"|format(f.mean_length_cm) }} cm</td>
                        </tr>
                      {% endfor %}
                      </tbody>
                    </table>
                  {% else %}
                    <p class="small text-muted mb-0">
                      Belum ada data panjang ikan yang dapat dirangkum.
                    </p>
                  {% endif %}
                </div>
              </div>
            {% else %}
              <!-- Placeholder ketika belum ada hasil -->
              <div class="empty-state">
                <div class="empty-icon">
                  <i class="fa-regular fa-circle-play"></i>
                </div>
                <div class="empty-title">
                  Belum ada analisis yang dijalankan
                </div>
                <div class="empty-caption">
                  Unggah sebuah video pada panel kiri, kemudian tekan
                  <span class="fw-semibold">Cek Ikan</span> untuk memulai proses.
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-card">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <p class="mb-1 fw-semibold">Video sedang dianalisis</p>
    <p class="mb-0 small text-muted">
      Sistem menjalankan deteksi pose, pelacakan ID, dan pengukuran panjang ikan.
    </p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>

</body>
</html>
